<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Joshua‚Äôs Bible Library</title>
  <meta name="description" content="Bible notes, papers, and articles." />
  <style>
    :root{
      --bg: #0b0d12;
      --panel: #121727;
      --panel-2: #0f1422;
      --text: #e9eefc;
      --muted: #aab4d0;
      --border: rgba(255,255,255,.08);
      --accent: #7aa2ff;
      --accent-2:#9bffd6;
      --danger:#ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --maxw: 1100px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    [data-theme="light"]{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --panel-2:#f3f5fb;
      --text:#0c1020;
      --muted:#5b647a;
      --border: rgba(12,16,32,.10);
      --accent:#335dff;
      --accent-2:#0aa77d;
      --danger:#d74646;
      --shadow: 0 10px 30px rgba(12,16,32,.10);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 20% 0%, rgba(122,162,255,.18), transparent 60%),
                  radial-gradient(900px 700px at 90% 20%, rgba(155,255,214,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
      line-height:1.55;
    }
    a{color:inherit}
    .wrap{max-width:var(--maxw); margin:0 auto; padding:24px}
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(12px);
      background: color-mix(in srgb, var(--bg) 78%, transparent);
      border-bottom:1px solid var(--border);
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:14px 24px; max-width:var(--maxw); margin:0 auto;
    }
    .brand{
      display:flex; align-items:center; gap:12px; min-width:220px;
      text-decoration:none;
    }
    .logo{
  width:88px;
  height:88px;
  border-radius:50%;
  object-fit: cover;
  box-shadow: var(--shadow);
}
    .brand h1{font-size:15px; margin:0; letter-spacing:.2px}
    .brand p{margin:0; color:var(--muted); font-size:12px}
    nav{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 12px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--panel) 92%, transparent);
      border-radius:999px;
      text-decoration:none;
      color:var(--text);
      font-size:13px;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      user-select:none;
      cursor:pointer;
    }
    .pill:hover{transform: translateY(-1px); border-color: color-mix(in srgb, var(--accent) 55%, var(--border));}
    .pill.active{
      border-color: color-mix(in srgb, var(--accent) 60%, var(--border));
      background: color-mix(in srgb, var(--accent) 18%, var(--panel));
    }
    .pill .dot{
      width:8px; height:8px; border-radius:999px; background: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 18%, transparent);
    }

    main{padding:22px 0 60px}
    .hero{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1.4fr .9fr;
      gap:18px;
      align-items:stretch;
    }
    .card{
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--panel) 92%, transparent);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .hero h2{margin:0 0 8px; font-size:22px; letter-spacing:.2px}
    .hero p{margin:0 0 14px; color:var(--muted)}
    .kpis{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .kpi{
      flex: 1 1 120px;
      padding:12px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--panel-2) 86%, transparent);
      border-radius:14px;
    }
    .kpi b{display:block; font-size:16px}
    .kpi span{color:var(--muted); font-size:12px}
    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:12px;
    }
    .search{
      flex: 1 1 260px;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--panel-2) 92%, transparent);
      border-radius: 14px;
    }
    .search input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
    }
    .select{
      flex: 0 0 auto;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--panel-2) 92%, transparent);
      border-radius: 14px;
      padding:10px 12px;
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
      margin-top:18px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 620px){ .grid{grid-template-columns: 1fr;} }

    .item{
      padding:14px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--panel) 92%, transparent);
      border-radius: 16px;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease;
      min-height: 160px;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .item:hover{transform: translateY(-2px); border-color: color-mix(in srgb, var(--accent) 55%, var(--border));}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--panel-2) 90%, transparent);
      color:var(--muted);
      font-size:12px;
      width:fit-content;
    }
    .badge strong{color:var(--text); font-weight:600}
    .title{
      margin:10px 0 6px;
      font-size:16px;
      letter-spacing:.15px;
    }
    .excerpt{
      margin:0 0 10px;
      color:var(--muted);
      font-size:13px;
      display:-webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .meta{
      display:flex; justify-content:space-between; gap:10px;
      color:var(--muted); font-size:12px;
      align-items:center;
    }
    .tags{display:flex; gap:6px; flex-wrap:wrap}
    .tag{
      font-family:var(--mono);
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--panel-2) 88%, transparent);
      color: color-mix(in srgb, var(--muted) 80%, var(--text));
    }
    .split{
      display:grid;
      grid-template-columns: 1fr 380px;
      gap:14px;
      margin-top:18px;
      align-items:start;
    }
    @media (max-width: 980px){ .split{grid-template-columns: 1fr;} }

    /* Reader modal */
    .overlay{
      position:fixed; inset:0; z-index:100;
      background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:18px;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(960px, 100%);
      max-height: 88vh;
      overflow:auto;
      border-radius: 18px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--panel) 94%, transparent);
      box-shadow: var(--shadow);
    }
    .modal header{
      position:sticky; top:0;
      background: color-mix(in srgb, var(--panel) 92%, transparent);
      border-bottom:1px solid var(--border);
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      backdrop-filter: blur(10px);
    }
    .modal header h3{margin:0; font-size:16px}
    .modal .content{padding:16px}
    .modal .content h1{margin:0 0 8px; font-size:22px}
    .modal .content .sub{
      color:var(--muted); font-size:13px; margin-bottom:12px
    }
    .modal .content .body{
      white-space:pre-wrap;
      font-size:15px;
    }
    .btn{
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--panel-2) 92%, transparent);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      text-decoration:none;
    }
    .btn:hover{border-color: color-mix(in srgb, var(--accent) 55%, var(--border));}
    .btn.danger{border-color: color-mix(in srgb, var(--danger) 50%, var(--border));}
    .footer{
      margin-top:22px;
      color:var(--muted);
      font-size:12px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      border-top:1px solid var(--border);
      padding-top:16px;
    }
    .smalllink{color:var(--muted); text-decoration:none}
    .smalllink:hover{color:var(--text)}
/* =========================
   MOBILE FIXES (paste at END of <style>)
========================= */

img, video {
  max-width: 100%;
  height: auto;
}
iframe {
  max-width: 100%;
}

html, body { overflow-x: hidden; }

/* Make header content wrap nicely on phones */
@media (max-width: 620px) {
    /* MOBILE ORDER: show Library before Featured */
 main.wrap{
  display: flex;
  flex-direction: column;
}

  .hero{ order: 1; }   /* Welcome/Search section */
  .split{ order: 2; }  /* Library section */

  /* Featured card is inside .hero */
  .hero > aside.card{ order: 3; }
  .topbar{
    flex-direction: column;
    align-items: flex-start;
    padding: 12px 14px;
    gap: 10px;
  }

  .brand{
    width: 100%;
    min-width: unset;
  }

  .logo{
    width: 64px;
    height: 64px;
  }

 nav{
  width: 100%;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

  .pill{
  width: 100%;
  justify-content: center;
  padding: 8px 10px;
  font-size: 12px;
}

 main.wrap{ padding: 14px; }
  .card{ padding: 14px; }

 .controls{
  flex-direction: column;
  align-items: center;
}

/* Match the width of the Featured card */
.hero .card,
.search{
  width: calc(100% - 28px);   /* same as mobile wrap padding */
  max-width: 520px;
}

.select{
  width: calc(100% - 28px);
  max-width: 520px;
}

  .overlay{ padding: 10px; }
  .modal{ max-height: 92vh; }
  .modal .content h1{ font-size: 18px; }
  .modal .content .body{ font-size: 14px; }

  .modal iframe{
    height: 70vh !important;
    width: 100% !important;
  }
}

/* Mid-size tablets: keep things comfortable */
@media (max-width: 920px) {
  .topbar{ padding: 12px 16px; }
  .wrap{ padding: 18px; }
}
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#" id="homeLink">
      <img class="logo" src="IMG_6142.jpeg" alt="Joshua Haub" />
        <div>
          <h1>Joshua Haub Biblical Material</h1>
          <p>Notes ‚Ä¢ Papers ‚Ä¢ Articles</p>
        </div>
      </a>

      <nav aria-label="Primary">
       <button class="pill active" id="filterAll"><span class="dot"></span>All</button>
        <button class="pill" id="filterNotes"><span class="dot"></span>Notes</button>
        <button class="pill" id="filterPapers"><span class="dot"></span>Papers</button>
        <button class="pill" id="filterArticles"><span class="dot"></span>Articles</button>
        <button class="pill" id="themeToggle" title="Toggle theme">üåì Theme</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <div class="card">
        <h2> Welcome to my Bible Library</h2>
        <p>
          Feel free to download these files for personal use in your personal Bible study.
        </p>

        <div class="controls">
          <div class="search" role="search" aria-label="Search library">
            üîé
            <input id="searchInput" placeholder="Search titles, content, tags‚Ä¶ (e.g., ‚Äútextual criticism‚Äù)" />
          </div>

          <select class="select" id="sortSelect" aria-label="Sort">
            <option value="newest">Sort: Newest</option>
            <option value="oldest">Sort: Oldest</option>
            <option value="titleaz">Sort: Title A‚ÄìZ</option>
            <option value="titleza">Sort: Title Z‚ÄìA</option>
          </select>

          <select class="select" id="tagSelect" aria-label="Tag filter">
            <option value="">Tag: (All)</option>
          </select>
        </div>

        <div class="kpis" id="kpis"></div>
      </div>

      <aside class="card">
        <h2 style="font-size:18px;margin-bottom:8px;">Featured</h2>
        <p style="color:var(--muted);margin-top:0">
          Pin your best work here (set <span style="font-family:var(--mono)">featured: true</span>).
        </p>
        <div id="featuredList" style="display:flex;flex-direction:column;gap:10px;"></div>
      </aside>
    </section>

    <section class="split">
      <div>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:6px;">
          <h2 style="margin:0;font-size:18px;">Library</h2>
          <div style="color:var(--muted);font-size:13px;">
            <span id="resultsCount">0</span> results
          </div>
        </div>

        <div class="grid" id="grid"></div>
      </div>

      <aside class="card">
        <h2 style="font-size:18px;margin:0 0 10px;">About</h2>
        <p style="margin:0;color:var(--muted);">
          My name is Joshua Haub and I am an Evangelist and Preacher. My goal in life is to help other people learn about God and His Word. Please feel free to use my material here (free of charge) however best helps you understand these important matters.
        </p>

        <div style="height:12px"></div>

        <div style="border:1px solid var(--border); border-radius:14px; padding:12px; background: color-mix(in srgb, var(--panel-2) 88%, transparent);">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <b>Quick Links</b>
            <span style="color:var(--muted); font-size:12px;"></span>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px; margin-top:10px;">
            <a class="smalllink" href="#" onclick="scrollToTop(); return false;">‚Ä¢ Home</a>
            <a class="smalllink" href="#" onclick="setTypeFilter('Notes'); return false;">‚Ä¢ Notes</a>
            <a class="smalllink" href="#" onclick="setTypeFilter('Papers'); return false;">‚Ä¢ Papers</a>
            <a class="smalllink" href="#" onclick="setTypeFilter('Articles'); return false;">‚Ä¢ Articles</a>
          </div>
        </div>

        <div style="height:14px"></div>

        <h2 style="font-size:18px;margin:0 0 10px;">How To Contact Me</h2>
        <ol style="margin:0; padding-left:18px; color:var(--muted); font-size:13px;">
          <!-- CHANGED: made URLs clickable + fixed broken tags -->
          <li>
            Instagram
            <span style="font-family:var(--mono)">
              <a href="https://www.instagram.com/generousj_?igsh=MXkya3I5eXFmdXBqOA%3D%3D&utm_source=qr" target="_blank" rel="noopener noreferrer">
                https://www.instagram.com/generousj_
              </a>
            </span>
          </li>
          <li>
            Facebook
            <span style="font-family:var(--mono)">
              <a href="https://www.facebook.com/joshua.haub.538481" target="_blank" rel="noopener noreferrer">
                https://www.facebook.com/joshua.haub.538481
              </a>
            </span>
          </li>
          <li>
            X <span style="font-family:var(--mono)">(Formerly Twitter)</span>
            <span style="font-family:var(--mono)">
              <a href="https://x.com/joshhaub" target="_blank" rel="noopener noreferrer">
                https://x.com/joshhaub
              </a>
            </span>
          </li>
        </ol>
      </aside>
    </section>

    <footer class="footer">
      <div>¬© <span id="year"></span> Joshua‚Äôs Bible Library</div>
      <div> To Him Be the Glory</div>
    </footer>
  </main>

  <!-- Reader Modal -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-label="Reader">
    <div class="modal">
      <header>
        <h3 id="modalType">Reader</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <!-- CHANGED: added top-right download icon/button (hidden unless pdfHref exists) -->
          <a class="btn" id="downloadBtn" href="#" download title="Download PDF" style="display:none;">‚¨áÔ∏è</a>
          <button class="btn" id="copyLinkBtn">Copy Link</button>
          <button class="btn danger" id="closeBtn">Close</button>
        </div>
      </header>
      <div class="content">
        <h1 id="modalTitle"></h1>
        <div class="sub" id="modalSub"></div>
        <div class="tags" id="modalTags" style="margin-bottom:12px;"></div>
        <div class="body" id="modalBody"></div>
      </div>
    </div>
  </div>

  <script>
    /*************************************************************
     * EDIT YOUR CONTENT HERE
     *************************************************************/
    const CONTENT = [
      {
        id: "john-7-53-8-11",
        type: "Papers",
        title: "Is John 7:53‚Äì8:11 Part of the Original Text of John?",
        date: "2026-01-06",
        featured: true,
        tags: ["John", "Textual Criticism", "Pericope Adulterae"],
        excerpt: "A textual-critical analysis of John 7:53‚Äì8:11 and its manuscript evidence.",
        // CHANGED: added explicit href for the top-right download icon
        pdfHref: "John%207:53-8:11.pdf",
        body: `
<iframe
  src="John%207:53-8:11.pdf"
  width="100%"
  height="900"
  style="border:none;"
></iframe>

<p>
  <a href="John%207:53-8:11.pdf" download>
    Download PDF
  </a>
</p>
`
      }
    ];

    /*************************************************************
     * APP LOGIC (No need to edit below unless you want to)
     *************************************************************/
    const els = {
      grid: document.getElementById("grid"),
      featuredList: document.getElementById("featuredList"),
      kpis: document.getElementById("kpis"),
      resultsCount: document.getElementById("resultsCount"),
      searchInput: document.getElementById("searchInput"),
      sortSelect: document.getElementById("sortSelect"),
      tagSelect: document.getElementById("tagSelect"),
      year: document.getElementById("year"),

      filterAll: document.getElementById("filterAll"),
      filterNotes: document.getElementById("filterNotes"),
      filterPapers: document.getElementById("filterPapers"),
      filterArticles: document.getElementById("filterArticles"),
      themeToggle: document.getElementById("themeToggle"),

      overlay: document.getElementById("overlay"),
      modalTitle: document.getElementById("modalTitle"),
      modalSub: document.getElementById("modalSub"),
      modalBody: document.getElementById("modalBody"),
      modalTags: document.getElementById("modalTags"),
      modalType: document.getElementById("modalType"),
      closeBtn: document.getElementById("closeBtn"),
      copyLinkBtn: document.getElementById("copyLinkBtn"),
      // CHANGED: grab the download button element
      downloadBtn: document.getElementById("downloadBtn"),

      exportBtn: document.getElementById("exportBtn"),
      importBtn: document.getElementById("importBtn"),
      clearFiltersBtn: document.getElementById("clearFiltersBtn"),
      homeLink: document.getElementById("homeLink"),
    };

    let state = {
      type: "All",     // All | Notes | Papers | Articles
      query: "",
      tag: "",
      sort: "newest",
      theme: localStorage.getItem("theme") || "dark",
    };

    function applyTheme() {
      document.documentElement.setAttribute("data-theme", state.theme === "light" ? "light" : "dark");
      localStorage.setItem("theme", state.theme);
    }

    function normalize(s){ return (s || "").toLowerCase(); }

    function formatDate(iso){
      // iso YYYY-MM-DD
      try {
        const [y,m,d] = iso.split("-").map(Number);
        const dt = new Date(y, m-1, d);
        return dt.toLocaleDateString(undefined, {year:"numeric", month:"short", day:"numeric"});
      } catch { return iso; }
    }

    function contentMatches(item) {
      const q = normalize(state.query).trim();
      if (state.type !== "All" && item.type !== state.type) return false;
      if (state.tag && !(item.tags || []).includes(state.tag)) return false;

      if (!q) return true;

      const hay = normalize([
        item.title,
        item.excerpt,
        item.body,
        (item.tags || []).join(" ")
      ].join(" | "));

      return hay.includes(q);
    }

    function sortItems(items) {
      const s = state.sort;
      const copy = [...items];
      if (s === "newest") copy.sort((a,b)=> (b.date || "").localeCompare(a.date || ""));
      if (s === "oldest") copy.sort((a,b)=> (a.date || "").localeCompare(b.date || ""));
      if (s === "titleaz") copy.sort((a,b)=> (a.title || "").localeCompare(b.title || ""));
      if (s === "titleza") copy.sort((a,b)=> (b.title || "").localeCompare(a.title || ""));
      return copy;
    }

    function setActiveFilterButtons(){
      const map = {
        "All": els.filterAll,
        "Notes": els.filterNotes,
        "Papers": els.filterPapers,
        "Articles": els.filterArticles
      };
      [els.filterAll, els.filterNotes, els.filterPapers, els.filterArticles].forEach(b=>b.classList.remove("active"));
      map[state.type].classList.add("active");
    }

    function buildKPIs(){
      const total = CONTENT.length;
      const notes = CONTENT.filter(x=>x.type==="Notes").length;
      const papers = CONTENT.filter(x=>x.type==="Papers").length;
      const articles = CONTENT.filter(x=>x.type==="Articles").length;

      const featured = CONTENT.filter(x=>x.featured).length;

      const kpis = [
        {label:"Total", value: total},
        {label:"Notes", value: notes},
        {label:"Papers", value: papers},
        {label:"Articles", value: articles},
        {label:"Featured", value: featured},
      ];

      els.kpis.innerHTML = kpis.map(k=>`
        <div class="kpi">
          <b>${k.value}</b>
          <span>${k.label}</span>
        </div>
      `).join("");
    }

    function buildTagSelect(){
      const set = new Set();
      CONTENT.forEach(x => (x.tags || []).forEach(t => set.add(t)));
      const tags = Array.from(set).sort((a,b)=>a.localeCompare(b));
      const current = state.tag;

      els.tagSelect.innerHTML =
        `<option value="">Tag: (All)</option>` +
        tags.map(t=>`<option value="${escapeHtml(t)}"${t===current ? " selected":""}>Tag: ${escapeHtml(t)}</option>`).join("");
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function itemCard(item){
      const tags = (item.tags || []).slice(0,4).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("");
      const extra = (item.tags || []).length > 4 ? `<span class="tag">+${(item.tags||[]).length - 4}</span>` : "";
      return `
        <article class="item" tabindex="0" role="button" aria-label="Open ${escapeHtml(item.title)}" data-id="${escapeHtml(item.id)}">
          <div>
            <div class="badge"><strong>${escapeHtml(item.type)}</strong> ¬∑ ${escapeHtml(formatDate(item.date || ""))}</div>
            <h3 class="title">${escapeHtml(item.title)}</h3>
            <p class="excerpt">${escapeHtml(item.excerpt || "")}</p>
          </div>
          <div class="meta">
            <div class="tags">${tags}${extra}</div>
            <div>${item.featured ? "‚òÖ" : ""}</div>
          </div>
        </article>
      `;
    }

    function renderFeatured(){
      const featured = sortItems(CONTENT.filter(x=>x.featured)).slice(0, 4);
      if (!featured.length){
        els.featuredList.innerHTML = `<div style="color:var(--muted);font-size:13px;">No featured posts yet.</div>`;
        return;
      }
      els.featuredList.innerHTML = featured.map(x=>`
        <div class="item" style="min-height:auto;" data-id="${escapeHtml(x.id)}">
          <div class="badge"><strong>${escapeHtml(x.type)}</strong> ¬∑ ${escapeHtml(formatDate(x.date || ""))}</div>
          <div style="height:6px"></div>
          <div style="font-weight:650;">${escapeHtml(x.title)}</div>
          <div style="color:var(--muted);font-size:12px;margin-top:4px;">${escapeHtml(x.excerpt || "")}</div>
        </div>
      `).join("");
    }

    function renderGrid(){
      setActiveFilterButtons();

      const filtered = CONTENT.filter(contentMatches);
      const sorted = sortItems(filtered);

      els.resultsCount.textContent = sorted.length;
      els.grid.innerHTML = sorted.map(itemCard).join("") || `
        <div class="card" style="grid-column: 1/-1;">
          <b>No results.</b>
          <div style="color:var(--muted); margin-top:6px;">
            Try removing filters or searching a different term.
          </div>
        </div>
      `;

      // Wire click handlers
      document.querySelectorAll("[data-id]").forEach(el=>{
        el.addEventListener("click", ()=> openReader(el.getAttribute("data-id")));
        el.addEventListener("keydown", (e)=>{
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            openReader(el.getAttribute("data-id"));
          }
        });
      });
    }

    function openReader(id){
      const item = CONTENT.find(x=>x.id === id);
      if (!item) return;

      els.modalType.textContent = item.type;
      els.modalTitle.textContent = item.title;
      els.modalSub.textContent = `${formatDate(item.date || "")} ‚Ä¢ ${item.featured ? "Featured ‚Ä¢ " : ""}${(item.tags || []).join(" ‚Ä¢ ")}`;

      // CHANGED: render iframe/link HTML for the PDF
      els.modalBody.innerHTML = item.body || "";

      // CHANGED: show/hide top-right download icon based on item.pdfHref
      if (item.pdfHref) {
        els.downloadBtn.href = item.pdfHref;
        els.downloadBtn.style.display = "inline-flex";
      } else {
        els.downloadBtn.href = "#";
        els.downloadBtn.style.display = "none";
      }

      els.modalTags.innerHTML = (item.tags || []).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("");

      els.overlay.classList.add("show");
      document.body.style.overflow = "hidden";

      // update hash for deep linking
      history.replaceState(null, "", `#/${encodeURIComponent(item.id)}`);
    }

    function closeReader(){
      els.overlay.classList.remove("show");
      document.body.style.overflow = "";
      // return to library view hash
      history.replaceState(null, "", "#/");
    }

    function hydrateFromHash(){
      const h = location.hash || "#/";
      const m = h.match(/^#\/(.+)$/);
      if (m && m[1] && m[1] !== "") {
        const id = decodeURIComponent(m[1]);
        const exists = CONTENT.some(x=>x.id === id);
        if (exists) openReader(id);
      }
    }

    function setTypeFilter(type){
      state.type = type;
      renderGrid();
      scrollToTop();
    }
    window.setTypeFilter = setTypeFilter;

    function scrollToTop(){
      window.scrollTo({top:0, behavior:"smooth"});
    }
    window.scrollToTop = scrollToTop;

    function clearFilters(){
      state.type = "All";
      state.query = "";
      state.tag = "";
      state.sort = "newest";
      els.searchInput.value = "";
      els.sortSelect.value = "newest";
      buildTagSelect();
      renderGrid();
      scrollToTop();
    }

    function exportJSON(){
      const payload = JSON.stringify(CONTENT, null, 2);
      const blob = new Blob([payload], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "bible-library-content.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function importJSON(){
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "application/json";
      input.onchange = async () => {
        const file = input.files && input.files[0];
        if (!file) return;
        const text = await file.text();
        try {
          const parsed = JSON.parse(text);
          if (!Array.isArray(parsed)) throw new Error("JSON must be an array.");
          alert("Imported JSON successfully. NOTE: This demo file does not overwrite the hard-coded CONTENT array.\n\nTo use imports permanently, you‚Äôd store parsed data in localStorage or load it from a separate .json file.");
        } catch (e) {
          alert("Import failed: " + e.message);
        }
      };
      input.click();
    }

    // Event wiring
    els.filterAll.addEventListener("click", ()=> setTypeFilter("All"));
    els.filterNotes.addEventListener("click", ()=> setTypeFilter("Notes"));
    els.filterPapers.addEventListener("click", ()=> setTypeFilter("Papers"));
    els.filterArticles.addEventListener("click", ()=> setTypeFilter("Articles"));

    els.themeToggle.addEventListener("click", ()=>{
      state.theme = (state.theme === "light") ? "dark" : "light";
      applyTheme();
    });

    els.searchInput.addEventListener("input", (e)=>{
      state.query = e.target.value || "";
      renderGrid();
    });

    els.sortSelect.addEventListener("change", (e)=>{
      state.sort = e.target.value;
      renderGrid();
    });

    els.tagSelect.addEventListener("change", (e)=>{
      state.tag = e.target.value || "";
      renderGrid();
    });

    els.closeBtn.addEventListener("click", closeReader);
    els.overlay.addEventListener("click", (e)=>{
      if (e.target === els.overlay) closeReader();
    });
    document.addEventListener("keydown", (e)=>{
      if (e.key === "Escape" && els.overlay.classList.contains("show")) closeReader();
    });

    els.copyLinkBtn.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(location.href);
        els.copyLinkBtn.textContent = "Copied!";
        setTimeout(()=> els.copyLinkBtn.textContent = "Copy Link", 900);
      } catch {
        alert("Couldn‚Äôt copy automatically. You can manually copy the URL from the address bar.");
      }
    });

   els.exportBtn?.addEventListener("click", (e)=>{ e.preventDefault(); exportJSON(); });
els.importBtn?.addEventListener("click", (e)=>{ e.preventDefault(); importJSON(); });
els.clearFiltersBtn?.addEventListener("click", (e)=>{ e.preventDefault(); clearFilters(); });
els.homeLink?.addEventListener("click", (e)=>{ e.preventDefault(); scrollToTop(); });

  // Init (runs whether DOMContentLoaded already fired or not)
function init() {
  state.theme = state.theme === "light" ? "light" : "dark";
  applyTheme();

  els.year.textContent = new Date().getFullYear();

  buildKPIs();
  buildTagSelect();
  renderFeatured();

  // Ensure default view is All and render immediately
  state.type = "All";
  renderGrid();

  hydrateFromHash();
  window.addEventListener("hashchange", hydrateFromHash);
}

if (document.readyState === "loading") {
  window.addEventListener("DOMContentLoaded", init);
} else {
  init();
}
  </script>
</body>
</html>
